
# Volumeê³¼ Storage

## ë°ì´í„° ì €ì¥ì´ ì™œ ì¤‘ìš”í•œê°€?

### ë¬¸ì œ ìƒí™©
```
ğŸ˜° Podì˜ ë°ì´í„° ë¬¸ì œì :
- Podê°€ ì¬ì‹œì‘ë˜ë©´ ëª¨ë“  ë°ì´í„°ê°€ ì‚¬ë¼ì§
- ê°™ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì—¬ëŸ¬ Podê°€ ë°ì´í„°ë¥¼ ê³µìœ í•  ìˆ˜ ì—†ìŒ
- ë°ì´í„°ë² ì´ìŠ¤ ê°™ì€ ì¤‘ìš”í•œ ë°ì´í„°ê°€ ìœ ì‹¤ë  ìˆ˜ ìˆìŒ
```

### Volumeì˜ í•´ê²°ì±…
```
ğŸ˜Š Volumeì˜ ì¥ì :
- Podê°€ ì¬ì‹œì‘ë˜ì–´ë„ ë°ì´í„° ìœ ì§€
- ì—¬ëŸ¬ Pod ê°„ì— ë°ì´í„° ê³µìœ  ê°€ëŠ¥
- ë‹¤ì–‘í•œ ìŠ¤í† ë¦¬ì§€ ì‹œìŠ¤í…œê³¼ ì—°ë™ ê°€ëŠ¥
```

## Volume íƒ€ì…ë³„ ì‰¬ìš´ ì„¤ëª…

### 1. emptyDir
**ë¹„ìœ **: ì„ì‹œ ì‘ì—… ê³µê°„
- **ìš©ë„**: Pod ë‚´ ì»¨í…Œì´ë„ˆë“¤ ê°„ ì„ì‹œ ë°ì´í„° ê³µìœ 
- **íŠ¹ì§•**: Pod ì‚­ì œ ì‹œ ë°ì´í„°ë„ í•¨ê»˜ ì‚­ì œ
- **ì˜ˆì‹œ**: ìºì‹œ, ì„ì‹œ íŒŒì¼, ë¡œê·¸ ë²„í¼

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: web-with-cache
spec:
  containers:
  - name: web-server
    image: nginx
    volumeMounts:
    - name: cache-volume
      mountPath: /tmp/cache
  
  - name: cache-warmer
    image: busybox
    command: ['sh', '-c', 'while true; do echo "cache data" > /tmp/cache/data; sleep 60; done']
    volumeMounts:
    - name: cache-volume
      mountPath: /tmp/cache
  
  volumes:
  - name: cache-volume
    emptyDir: {}
```

### 2. hostPath
**ë¹„ìœ **: í˜¸ìŠ¤íŠ¸ ì»´í“¨í„°ì˜ í´ë”ë¥¼ ë¹Œë ¤ ì“°ëŠ” ê²ƒ
- **ìš©ë„**: ë…¸ë“œì˜ íŒŒì¼ ì‹œìŠ¤í…œì— ì§ì ‘ ì ‘ê·¼
- **íŠ¹ì§•**: í•´ë‹¹ ë…¸ë“œì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥
- **ì˜ˆì‹œ**: ë¡œê·¸ ìˆ˜ì§‘, ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: log-collector
spec:
  containers:
  - name: log-reader
    image: busybox
    command: ['tail', '-f', '/host-logs/app.log']
    volumeMounts:
    - name: log-volume
      mountPath: /host-logs
  
  volumes:
  - name: log-volume
    hostPath:
      path: /var/log/myapp
      type: Directory
```

### 3. configMap / secret
**ë¹„ìœ **: ì„¤ì • íŒŒì¼ ë³´ê´€í•¨ì—ì„œ íŒŒì¼ì„ ê°€ì ¸ì™€ ì‚¬ìš©
- **ìš©ë„**: ì„¤ì • íŒŒì¼ì„ Podì— ë§ˆìš´íŠ¸
- **íŠ¹ì§•**: ì½ê¸° ì „ìš©, ì„¤ì • ë³€ê²½ ì‹œ ìë™ ì—…ë°ì´íŠ¸
- **ì˜ˆì‹œ**: ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •, ì¸ì¦ì„œ

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: web-with-config
spec:
  containers:
  - name: nginx
    image: nginx
    volumeMounts:
    - name: config-volume
      mountPath: /etc/nginx/nginx.conf
      subPath: nginx.conf
  
  volumes:
  - name: config-volume
    configMap:
      name: nginx-config
```

## Persistent Volume (PV)ì™€ Persistent Volume Claim (PVC)

### ê°œë… ì´í•´
```mermaid
graph TD
    A[ê´€ë¦¬ì] --> B[PV ìƒì„±]
    B --> C[Storage Pool]
    D[ê°œë°œì] --> E[PVC ìš”ì²­]
    E --> F[PVì™€ ìë™ ì—°ê²°]
    F --> G[Podì—ì„œ ì‚¬ìš©]
```

### ì‰¬ìš´ ë¹„ìœ 
- **PV**: ì°½ê³  ê±´ë¬¼ (ê´€ë¦¬ìê°€ ë¯¸ë¦¬ ì¤€ë¹„)
- **PVC**: ì°½ê³  ì„ëŒ€ ì‹ ì²­ì„œ (ê°œë°œìê°€ í•„ìš”í•  ë•Œ ìš”ì²­)
- **Binding**: ì ì ˆí•œ ì°½ê³ ë¥¼ ìë™ìœ¼ë¡œ ë°°ì •

### PV ìƒì„± (ê´€ë¦¬ì)
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: my-pv
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: manual
  hostPath:
    path: /data/my-app
```

### PVC ìƒì„± (ê°œë°œì)
```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: manual
```

### Podì—ì„œ PVC ì‚¬ìš©
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: app-with-storage
spec:
  containers:
  - name: app
    image: nginx
    volumeMounts:
    - name: data-volume
      mountPath: /usr/share/nginx/html
  
  volumes:
  - name: data-volume
    persistentVolumeClaim:
      claimName: my-pvc
```

## ì ‘ê·¼ ëª¨ë“œ (Access Modes)

### ReadWriteOnce (RWO)
- **ì„¤ëª…**: í•˜ë‚˜ì˜ ë…¸ë“œì—ì„œë§Œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
- **ìš©ë„**: ë°ì´í„°ë² ì´ìŠ¤, ë‹¨ì¼ Pod ì• í”Œë¦¬ì¼€ì´ì…˜
- **ì˜ˆì‹œ**: MySQL, PostgreSQL

### ReadOnlyMany (ROX)
- **ì„¤ëª…**: ì—¬ëŸ¬ ë…¸ë“œì—ì„œ ì½ê¸°ë§Œ ê°€ëŠ¥
- **ìš©ë„**: ì •ì  ì½˜í…ì¸ , ê³µìœ  ì„¤ì • íŒŒì¼
- **ì˜ˆì‹œ**: ì›¹ì‚¬ì´íŠ¸ ì´ë¯¸ì§€, ë¬¸ì„œ íŒŒì¼

### ReadWriteMany (RWX)
- **ì„¤ëª…**: ì—¬ëŸ¬ ë…¸ë“œì—ì„œ ë™ì‹œì— ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
- **ìš©ë„**: ê³µìœ  íŒŒì¼ ì‹œìŠ¤í…œ
- **ì˜ˆì‹œ**: ë¡œê·¸ ìˆ˜ì§‘, ê³µìœ  ì—…ë¡œë“œ í´ë”

## ì‹¤ìŠµ: ë°ì´í„°ë² ì´ìŠ¤ Pod ë§Œë“¤ê¸°

### 1. PVC ìƒì„±
```yaml
# mysql-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
```

```bash
kubectl apply -f mysql-pvc.yaml
```

### 2. MySQL Deployment
```yaml
# mysql-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: "rootpassword"
        - name: MYSQL_DATABASE
          value: "myapp"
        ports:
        - containerPort: 3306
        volumeMounts:
        - name: mysql-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-storage
        persistentVolumeClaim:
          claimName: mysql-pvc
```

### 3. ë°ì´í„° í™•ì¸
```bash
# ë°°í¬
kubectl apply -f mysql-deployment.yaml

# Pod í™•ì¸
kubectl get pods

# MySQLì— ì ‘ì†í•´ì„œ ë°ì´í„° ìƒì„±
kubectl exec -it mysql-<pod-id> -- mysql -u root -p

# Pod ì‚­ì œ í›„ ì¬ìƒì„±í•´ë„ ë°ì´í„° ìœ ì§€ í™•ì¸
kubectl delete pod mysql-<pod-id>
```

## StorageClass í™œìš©

### ë™ì  í”„ë¡œë¹„ì €ë‹
**StorageClass**ëŠ” **ìë™ ì°½ê³  ê±´ì„¤ì—…ì²´**ì™€ ê°™ìŠµë‹ˆë‹¤:
- PVC ìš”ì²­ì´ ì˜¤ë©´ ìë™ìœ¼ë¡œ PVë¥¼ ìƒì„±
- ë‹¤ì–‘í•œ ìŠ¤í† ë¦¬ì§€ íƒ€ì… ì§€ì› (SSD, HDD ë“±)
- í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ íŠ¹íˆ ìœ ìš©

```yaml
# storageclass.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp3
  fsType: ext4
allowVolumeExpansion: true
reclaimPolicy: Delete
```

### StorageClassë¥¼ ì‚¬ìš©í•˜ëŠ” PVC
```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: app-pvc-ssd
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: fast-ssd  # ìë™ìœ¼ë¡œ SSD PV ìƒì„±
  resources:
    requests:
      storage: 100Gi
```

## ì‹¤ì œ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ + ë°ì´í„°ë² ì´ìŠ¤
```yaml
# ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ìš© - ê³µìœ  ì—…ë¡œë“œ í´ë”
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: web-uploads-pvc
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 50Gi

---
# ë°ì´í„°ë² ì´ìŠ¤ìš© - ì „ìš© ìŠ¤í† ë¦¬ì§€
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: database-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 200Gi
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: ë¡œê·¸ ìˆ˜ì§‘ ì‹œìŠ¤í…œ
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: log-collector
spec:
  containers:
  - name: app
    image: nginx
    volumeMounts:
    - name: app-logs
      mountPath: /var/log/nginx
  
  - name: log-shipper
    image: fluent/fluent-bit
    volumeMounts:
    - name: app-logs
      mountPath: /var/log/nginx
      readOnly: true
  
  volumes:
  - name: app-logs
    emptyDir: {}
```

## ë°±ì—…ê³¼ ë³µêµ¬

### ë°ì´í„° ë°±ì—…
```bash
# PVC ë°ì´í„°ë¥¼ ë‹¤ë¥¸ Podë¡œ ë°±ì—…
kubectl run backup-pod --image=busybox --rm -it \
  --overrides='{"spec":{"volumes":[{"name":"data","persistentVolumeClaim":{"claimName":"mysql-pvc"}}],"containers":[{"name":"backup","image":"busybox","volumeMounts":[{"name":"data","mountPath":"/data"}]}]}}'

# ë°±ì—… ìˆ˜í–‰
tar -czf /tmp/backup.tar.gz /data
```

### ìŠ¤ëƒ…ìƒ· (ì§€ì›í•˜ëŠ” ìŠ¤í† ë¦¬ì§€)
```yaml
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshot
metadata:
  name: mysql-snapshot
spec:
  volumeSnapshotClassName: csi-hostpath-snapclass
  source:
    persistentVolumeClaimName: mysql-pvc
```

## ì„±ëŠ¥ ìµœì í™”

### 1. ì ì ˆí•œ ìŠ¤í† ë¦¬ì§€ íƒ€ì… ì„ íƒ
```yaml
# ê³ ì„±ëŠ¥ì´ í•„ìš”í•œ ê²½ìš°
storageClassName: fast-ssd

# ìš©ëŸ‰ì´ ì¤‘ìš”í•œ ê²½ìš°
storageClassName: standard-hdd

# ì„ì‹œ ë°ì´í„°ì¸ ê²½ìš°
emptyDir:
  medium: Memory  # ë©”ëª¨ë¦¬ ê¸°ë°˜ (ë§¤ìš° ë¹ ë¦„)
```

### 2. I/O íŒ¨í„´ ê³ ë ¤
```yaml
# ìˆœì°¨ ì ‘ê·¼ì´ ë§ì€ ê²½ìš° (ë¡œê·¸, ë°±ì—…)
accessModes:
  - ReadWriteOnce

# ëœë¤ ì ‘ê·¼ì´ ë§ì€ ê²½ìš° (ë°ì´í„°ë² ì´ìŠ¤)
accessModes:
  - ReadWriteOnce
# + SSD ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©
```

## ë¬¸ì œ í•´ê²°

### ì¼ë°˜ì ì¸ ë¬¸ì œë“¤

#### 1. PVCê°€ Pending ìƒíƒœ
```bash
# PVC ìƒíƒœ í™•ì¸
kubectl describe pvc my-pvc

# ì‚¬ìš© ê°€ëŠ¥í•œ PV í™•ì¸
kubectl get pv

# StorageClass í™•ì¸
kubectl get storageclass
```

#### 2. Podê°€ Volumeì„ ë§ˆìš´íŠ¸í•  ìˆ˜ ì—†ìŒ
```bash
# Pod ì´ë²¤íŠ¸ í™•ì¸
kubectl describe pod my-pod

# ë…¸ë“œì˜ ë§ˆìš´íŠ¸ ìƒíƒœ í™•ì¸
kubectl get events --field-selector involvedObject.name=my-pod
```

#### 3. ì„±ëŠ¥ ë¬¸ì œ
```bash
# ë””ìŠ¤í¬ I/O í™•ì¸
kubectl exec -it my-pod -- iostat -x 1

# ë³¼ë¥¨ ì‚¬ìš©ëŸ‰ í™•ì¸
kubectl exec -it my-pod -- df -h
```

## ëª¨ë²” ì‚¬ë¡€

### 1. ì ì ˆí•œ í¬ê¸° ê³„íš
```bash
# í˜„ì¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§
kubectl exec -it mysql-pod -- du -sh /var/lib/mysql

# ì„±ì¥ë¥  ê³ ë ¤í•´ì„œ ì—¬ìœ  ìˆê²Œ ì„¤ì •
storage: 100Gi  # í˜„ì¬ 30Gi ì‚¬ìš© ì¤‘ì´ë©´ 100Gië¡œ ì„¤ì •
```

### 2. ë°±ì—… ì „ëµ
```yaml
# ì •ê¸°ì ì¸ ë°±ì—…ì„ ìœ„í•œ CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: database-backup
spec:
  schedule: "0 2 * * *"  # ë§¤ì¼ ìƒˆë²½ 2ì‹œ
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: backup
            image: mysql:8.0
            command: ["mysqldump", "-h", "mysql", "-u", "root", "-p$MYSQL_ROOT_PASSWORD", "myapp"]
            volumeMounts:
            - name: backup-storage
              mountPath: /backup
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: backup-pvc
          restartPolicy: OnFailure
```

### 3. ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§
```bash
# ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ ì•Œë¦¼ ì„¤ì •
kubectl top pods --containers
kubectl describe pvc --all-namespaces
```

## ë‹¤ìŒ ë‹¨ê³„
ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬ë¥¼ ë§ˆìŠ¤í„°í–ˆë‹¤ë©´ [[Kubernetes ì‹¤ìŠµ ê°€ì´ë“œ]]ë¥¼ í†µí•´ ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°°í¬í•´ë³´ì„¸ìš”!


